name: Spell Check

permissions:
  pull-requests: write  # Allows creating/updating PR comments
  contents: read        # Allows reading repository contents

on:
  pull_request:
  push:
    branches: [dev, main]

jobs:
  spell-check:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event_name == 'pull_request'  # Only run on pull requests

    steps:
      - name: Check out the code
        uses: actions/checkout@v4

      - name: Run cspell Action
        uses: streetsidesoftware/cspell-action@v6
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          config: ./cspell.json
          files: |
            **/*.{php,blade.php,md,yml,yaml,json,js,jsx,ts,tsx,css,scss,vue}
          check_dot_files: false

      - name: Format Spell Check Results
        id: format-results
        run: |
          if [ -s cspell-reports/cspell-output.txt ]; then
            echo "## 📝 Spell Check Results:" > results.md
            echo "" >> results.md
            echo "| File | Line | Error | Suggested Fix |" >> results.md
            echo "|------|------|-------|---------------|" >> results.md
            while IFS= read -r line; do
              file=$(echo "$line" | cut -d: -f1)
              line_number=$(echo "$line" | cut -d: -f2)
              error=$(echo "$line" | cut -d: -f3 | awk '{$1=$1};1')
              suggestion=$(echo "$error" | grep -oP '\((.*?)\)' | tr -d '()')
              echo "| \`$file\` | $line_number | $error | $suggestion |" >> results.md
            done < cspell-reports/cspell-output.txt
            cat results.md
            echo "spell_check_result=$(cat results.md)" >> $GITHUB_OUTPUT
          else
            echo "spell_check_result=**🎉 No spelling errors found!**" >> $GITHUB_OUTPUT
          fi

      - name: Post Spell Check Results
        uses: thollander/actions-comment-pull-request@v3
        with:
          message: ${{ steps.format-results.outputs.spell_check_result }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          comment-tag: spell-check-result
          mode: upsert
          create-if-not-exists: true
